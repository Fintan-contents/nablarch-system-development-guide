# バッチの一般的な処理に関する実装方法

## 全般
### プロダクションコードの実装方法
- いわゆる業務ロジック(※)をServiceクラスに実装します。   
  ユニットテストで業務ロジックのテストを可能にするためであります。
- ファイルのアウトプットはActionクラスに実装します。

※ 入力データの加工等

### ユニットテストの実装方法
- クラス単体テストで行います。  
  (リクエスト単体テストは使用しない) 

## バッチのインプットについて

### DBのデータを入力とするバッチ
#### 入力データ読込部分の実装方法
- BatchActionを継承して実装します。
- readerにはDatabaseRecordReaderを使用します(※)。

※以下のようにstatementを生成してDatabaseRecordReaderに設定します。
````java
    /**
     * {@inheritDoc}
     * ファイル出力対象のデータを読み込む{@link DatabaseRecordReader}を生成する。
     */
    @Override
    public DataReader<SqlRow> createReader(ExecutionContext ctx) {

        int count = countByStatementSql("GET_OUTPUT_FILE_DATA");
        writeLog("M000000001", count);

        DatabaseRecordReader reader = new DatabaseRecordReader();
        SqlPStatement statement = getSqlPStatement("GET_OUTPUT_FILE_DATA");
        reader.setStatement(statement);
        return reader;

    }
````

### ファイルのデータを入力とするバッチ
#### 入力データ読込部分の実装方法
- リーターは `DataReader<フォームクラス>` を継承して実装します。
- アクションは `BatchAction<フォームクラス>` を継承して実装します。
- 具体的な実装は nablarch 解説書の「[ファイルをDBに登録するバッチの作成](https://nablarch.github.io/docs/LATEST/doc/application_framework/application_framework/batch/nablarch_batch/getting_started/nablarch_batch/index.html)」を参照してください。

## バッチのアプトプットについて

### ファイルを出力するバッチ
- ファイルパス管理は、ファイルパス管理機能を使用してください。  
  [Nablarchアプリケーションフレームワーク 解説書 7.5. ファイルパス管理](https://nablarch.github.io/docs/LATEST/doc/application_framework/application_framework/libraries/file_path_management.html#file-path-management)
- ファイル出力は、データバインドを使用してください。  
  [Nablarchアプリケーションフレームワーク 解説書 7.4.1. データバインド](https://nablarch.github.io/docs/LATEST/doc/application_framework/application_framework/libraries/data_io/data_bind.html)
- ファイルのオープン(ObjectMapperの生成)は、オーバーライドしたBatchActionBase#initialize内で行ってください。  
- ファイルのクローズ(ObjectMapperのクローズ)は、オーバーライドしたBatchActionBase#terminate内で行ってください。
