# 取引単体テストのテスト方法（Web）

## JMeterを利用した取引単体テスト内容の保存

1. JMeterをHTTPプロキシサーバを使用するため以下の内容で設定をする。
   * ホスト：localhost
   * ポート：8888
1. 操作ごとに[テスト計画-テンプレート.jmx](取引単体テストツール/テスト計画-テンプレート.jmx)をコピーし、リネームする。
1. 設定した[JMeter起動用バッチ.bat](取引単体テスト)をJMeterを起動する。
1. 2でコピーして作成したファイルをJMeterで開く。
1. 画面左側「HTTPプロキシサーバ」を選択し、「開始」ボタンを押下する。
1. ブラウザを開き、取引単体テストを行う。（ログインから行うこと）
   - ログイン画面表示後「テスト計画」→「スレッドグループ」→「記録コントローラ」に行が増えてリクエストが記録できていることを確認してください。
     - 記録できてない場合はプロキシ設定が間違っている可能性が高いので確認してください。
   - 2でコピーして作成したファイルと同じ位置にhtmlファイルが出力されていることを確認してください。
     - 作成されていない場合、設定した[JMeter起動用バッチ.bat](取引単体テスト)と同じ位置に出力されるjmeter.logを確認してください。
     - すでにhtmlが保存されている場合はエラーとなります。移動または削除してから実行してください。
1. テストに必要な操作が完了するごとに、JMeterのHTTPプロキシサーバを停止する。
1. HTMLファイルをおよび、実行時のDBのレコードを保存してください。
1. 取引単体テストの操作ごとに2から繰り返す。

## JMeterで記録した取引単体テストの修正

JMeterで記録した取引単体テスト内容（リクエスト）のうち、
画面項目の増減や変更などによりパラメーターに影響があった場合の修正方法について記載します。

1. 設定した[JMeter起動用バッチ.bat](取引単体テスト)をJMeterを起動する。
1. 記録したテスト計画（jmxファイルを）JMeterで開く。
1. 画面左側「テスト計画」→「スレッドグループ」→「記録コントローラ」から変更したいリクエストを特定し選択する。
1. 画面右側にリクエストの詳細が表示されるため、「HTTPリクエスト」→「parameter」から編集を行う。

## JMeterで記録した取引単体テストの再実行

JMeterで記録した取引単体テスト内容（リクエスト）はリクエストの発行とレスポンスの保存のみ行います。


1. 設定した[JMeter起動用バッチ.bat](取引単体テスト)をJMeterを起動する。
1. 記録したテスト計画（jmxファイル）をJMeterで開く。
1. 画面上部の実行ボタンを押す。

## 排他制御エラー

1. IDEでアプリを起動します。
1. chormeを起動します(以降ブラウザAと呼びます)。
1. ブラウザAのメニューから「シークレット ウインドウを開く」を選択し、もう1つChormeを起動します (以降ブラウザBと呼びます)。
   ２つのブラウザを開くのはセッションがブラウザ間で共有されてしまうことを防ぐためです。 
1. ブラウザA、ブラウザBともに、同じデータを表示した更新画面に遷移します。
1. ブラウザBで確定を行います。
1. ブラウザAで確定を押したときに排他制御エラーが発生したことを表す画面に遷移することを確認します。

## 二重サブミットエラー

1. IDEでアプリを起動します。
1. ブラウザを起動して、テスト対象の画面まで遷移します。
1. ブラウザでテスト対象のボタンをクリックします。
1. ブラウザの戻る機能で戻ります。
1. テスト対象のボタンをクリックします。  
   ここで、2と同じトークンが送信されるため、二重サブミットエラーを確認できます。


## 「メッセージ表示（項目別）」のテスト

「単体テスト仕様書」→「取引単体①」→「メッセージ表示（項目別）」のテストは、
エラーメッセージが適切な位置に表示されているかを確認します。    
以下の理由により、エラーのバリエーションのテストは行いません。

- 「適切なドメイン付与されていれば、適切なエラーメッセージが出る」ため、エラーのバリエーションのテストは不要であるため。  
  適切なドメインが付与されているか否かは、Formクラスのレビューで担保します。 
- 各項目、エラーメッセージを一種類ずつ確認すれば、バリデーションが機能しているかの確認はできるため。

相関チェックについてはユニットテストでテストします。
