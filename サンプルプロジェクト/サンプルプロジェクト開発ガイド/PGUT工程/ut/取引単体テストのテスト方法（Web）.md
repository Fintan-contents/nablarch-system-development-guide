# 取引単体テストのテスト方法（Web）

## 排他制御エラー

1. IDEでアプリを起動します。
1. chormeを起動します(以降ブラウザAと呼びます)。
1. ブラウザAのメニューから「シークレット ウインドウを開く」を選択し、もう1つChormeを起動します (以降ブラウザBと呼びます)。
   ２つのブラウザを開くのはセッションがブラウザ間で共有されてしまうことを防ぐためです。 
1. ブラウザA、ブラウザBともに、同じデータを表示した更新画面に遷移します。
1. ブラウザBで確定を行います。
1. ブラウザAで確定を押したときに排他制御エラーが発生したことを表す画面に遷移することを確認します。

## 二重サブミットエラー

1. IDEでアプリを起動します。
1. ブラウザを起動して、テスト対象の画面まで遷移します。
1. ブラウザでテスト対象のボタンをクリックします。
1. ブラウザの戻る機能で戻ります。
1. テスト対象のボタンをクリックします。  
   ここで、2と同じトークンが送信されるため、二重サブミットエラーを確認できます。


## 「メッセージ表示（項目別）」のテスト

「単体テスト仕様書」→「取引単体①」→「メッセージ表示（項目別）」のテストは、
エラーメッセージが適切な位置に表示されているかを確認します。    
以下の理由により、エラーのバリエーションのテストは行いません。

- 「適切なドメイン付与されていれば、適切なエラーメッセージが出る」ため、エラーのバリエーションのテストは不要であるため。  
  適切なドメインが付与されているか否かは、Formクラスのレビューで担保します。 
- 各項目、エラーメッセージを一種類ずつ確認すれば、バリデーションが機能しているかの確認はできるため。

相関チェックについてはユニットテストでテストします。

## 取引単体テストの再実施方法

エビデンスとして保存されたテスト計画を使用し取引単体テストを再実施する方法について記載します。
JMeterで記録したテスト計画はリクエストの発行とレスポンスの保存のみ行います。
そのため、データ準備は単体テスト用データダンプツール(YoyoTool)を使用します。

### ダンプツールを使用したデータ準備方法

データ準備は単体テスト用データダンプツール(YoyoTool)を使用し、取引単体テストのエビデンスをデータ準備に使用する方法について記載します。
この手順を行うことで、DBに変更がない限り前回の取引単体テストと同様のデータでテストをすることができます。

1. DUMP.xlsmを開き、[こちら](./エビデンスの取得方法（ログとDBダンプ）.md)を参照しテーブル定義一覧を更新してください。
1. MAINシートを開きデータを挿入するテーブルについてH列を「○」に変更してください。
1. エビデンスとして保存しているDBダンプファイルを開き挿入対象のテーブルをDUMP.xlsmのINSERTシートにコピーします。（INSERTシートに記載する内容ついては、使い方.xlsxを参照してください。）
1. DUMP.xlsmのMAINシート画面上部の「起動」をクリックします。
1. ダンプツールのウインドウが表示される。表示されたウインドウの「インサート」をクリックします。

### テスト計画の再実行方法

1. 実行前の状態をデータダンプとして取得します。
2. 設定した `JMeter起動用バッチ.bat` でJMeterを起動する。
3. 記録したテスト計画（jmxファイル）をJMeterで開く。
4. 画面上部の実行ボタンを押す。
   - リクエストごとに実行結果のレスポンスをテスト計画と同じ位置に出力します。すでに同名のファイルがある場合エラーとなるため実行前にHTMLファイルがないことを確認してください。
5. 実行後の状態をデータダンプとして取得します。

JMeterで記録したテスト計画のうち、
画面項目の増減や変更などによりパラメーターに影響があった場合の修正方法について記載します。

1. 画面左側「テスト計画」→「スレッドグループ」→「記録コントローラ」から変更したいリクエストを特定し選択する。
1. 画面右側にリクエストの詳細が表示されるため、「HTTPリクエスト」→「parameter」から編集を行う。

### テスト結果の確認方法

テスト計画と同じ位置にHTMLファイルが出力されるため、前回の結果と差分があるか、差分が想定通りであるかを確認してください。
前回ファイルに今回のファイルを上書きすることで、`$ git status` コマンドにて差分を確認できます。

データの内容については別途取得したデータダンプが想定通りの状態か確認してください。

### 自動実行
上記取引単体テストを、JUnitを使って自動実行する仕組みが用意されています。  
詳しくは [取引単体テストの自動実行方法（Web）](取引単体テストの自動実行方法（Web）.md) を参照してください。
