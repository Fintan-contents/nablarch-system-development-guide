# エビデンスの取得方法（画面）

## エビデンスの取得前の準備

### 画面ハードコピー

1. ウィンドウサイズ指定ツール(Sizer)を起動します。
1. ブラウザを起動します。
1. ブラウザの右下の角にマウスカーソルを当てて右クリックします。
1. 表示されたされたメニューをクリックし、テストに使用するブラウザのサイズに変更します。
1. 画面キャプチャツール(SnapCrab for Windows)を起動します。

### テスト計画・レスポンスファイル

テスト計画は取引単体テストを再実行するために使用します。
基本的に再実行時には一時停止をすることなどをしませんので、テストの途中でDBの内容を変更するようなものは行わないでください。

1. テストショットごとに[テスト計画-テンプレート.jmx](取引単体テストツール/テスト計画-テンプレート.jmx)をコピーし、リネームする。
1. 各自の環境用に設定した[JMeter起動用バッチ.bat](取引単体テスト)でJMeterを起動する。
1. 1でコピーして作成したファイルをJMeterで開く。


## エビデンスの取得方法

### 画面ハードコピー

画面ハードコピーツール(SnapCrab for Windows)を使用してスクリーンショットを取得します。  
デフォルトでは、ALT + PrintScreenでアクティブなウインドウのハードコピーを撮れます。  
取得したスクリーンショットは指定済みのディレクトリに保存されます。

### テスト計画

1. 画面左側「HTTPプロキシサーバ」を選択し、「開始」ボタンを押下する。
1. プロキシ用のダミー証明書をインストールする。
   - JMeterを解凍したディレクトリのbin配下に `ApacheJMeterTemporaryRootCA.crt` が生成されるためダブルクリックする。
   - 「証明書のインストール」->「現在のユーザー」->「証明書を全て次のストアに配置する」から「信頼されたルート証明機関」を選択し、インストールする。
   - 証明書の期限は7日間に設定されているため、期限が切れるたびにこの操作を行うこと。
1. JMeterをHTTPプロキシサーバとして使用する設定を行ったChromeのショートカットにてブラウザを開き、自端末のIPアドレスでアクセスし取引単体テストを行う。（ログインから行うこと）
   - ログイン画面表示後「テスト計画」→「スレッドグループ」→「記録コントローラ」に行が増えてリクエストが記録できていることを確認してください。
     - `localhost` でアクセスするとプロキシを設定してもブラウザがバイパスするため、自端末のIPアドレスでアクセスしてください。
     - 記録できてない場合はプロキシ設定が間違っている可能性が高いので確認してください。
     - 何らかの理由でエラーが発生している可能性がある場合、設定した[JMeter起動用バッチ.bat](取引単体テスト)と同じ位置に出力されるjmeter.logを確認してください。
1. 1つのテストケースで必要な操作完了後、JMeterのHTTPプロキシサーバを停止します。テスト計画を保存してください。
1. 取得したテスト計画が実行できることを確認します。
1. DBをテスト実行前の状態にします。[ここ](./取引単体テストのテスト方法（Web）.md#ダンプツールを使用したデータ準備方法)を参照してください。
1. 画面上部の実行ボタンを押します。
   - テスト計画（jmxファイル）と同じ位置にHTMLやCSS,JavaScriptファイルが出力されていることを確認してください。
     - 作成されていない場合、設定した[JMeter起動用バッチ.bat](取引単体テスト)と同じ位置に出力されるjmeter.logを確認してください。
     - すでにファイルが保存されている場合はエラーとなります。移動または削除してから再度実行してください。
1. DBの状態・出力されたレスポンスを確認し想定通りの結果か確認する。

### レスポンスファイル

テスト計画と同じ位置にHTML,CSS,JavaScriptファイルが出力されます。

ここで取得できるHTMLファイルは、自動テストのアサーションでレスポンスが変化していないことを確認するために使用します。
直接ブラウザで開いてもCSSが適用されないため、見た目の確認はできません。  
見た目の確認はJMeterでテストを記録するときに目視で行い、画面のハードコピーを保存するようにしてください。

見た目が確認できないのにCSSやJavaScriptを保存している理由は、「目視確認を行ったときのCSS,JavaScriptを保存しておき、それと同じファイルが再帰テストでも返却されていれば、ブラウザ上での結果は同じと言える」という考えに基づいています。

なお、出力されたHTMLファイルは二重サブミットトークンの値が本来のものとは異なります。
これは二重サブミットトークンの値は使用されるたびに変更されてる値であり、再帰テストを行った際この値に不要な差分が発生することを防ぐためです。

### エビデンスの取得後

`/サンプルプロジェクト/設計書/A1_プロジェクト管理システム/020_方式設計/020_開発標準/020_テスト標準/単体テスト標準.xlsx` の `3.3.4. エビデンスの格納方法` に従って保存します。