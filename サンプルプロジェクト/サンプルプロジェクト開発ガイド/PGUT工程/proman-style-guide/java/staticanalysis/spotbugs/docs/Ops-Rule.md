# SpotBugs運用ガイド

## 基本的な考え方

### 原則1: SpotBugs警告は全て解決します

SpotBugsで検出されるものはバグが埋め込まれたコードか、後々問題が発生しそうな危険なコードのどちらかです。
警告を許容するということは、バグや潜在的な問題のリスクを許容することと同義ですので、そのような運用にしてはいけません。

常に警告0件である状態をキープすることを目標とします。

### 原則2: SpotBugs警告を解消するために品質を下げてはいけません

開発者はSpotBugs警告を見つけたら対応をしなければなりませんが、 その際警告を回避するための修正をしたことによって、かえってソースコード品質を落とすようなことがあってはいけません。

このような場合は、有識者やプロジェクトのアーキテクトに相談して 適切な対処を仰ぐようにしましょう。

個人の判断で、SpotBugs警告を無理矢理回避しようとしてはいけません。 SpotBugsはコード品質を上げるため（下げないため）のものであり、 これを回避するためにコード品質を下げるのは本末転倒です。

### 原則3: 正当な理由があってSpotBugs警告となる場合、チェック対象から外します

原則1で述べた通り、SpotBugs警告は基本的にはバグもしくは潜在的な問題のリスクを表します。
よって、チェック対象から除外する正当な理由は考え難いです。

ただし、自動生成されたソースコードはチェック対象から除外しても良いでしょう。
仮に自動生成されたソースコードにSpotBugs警告が出るような場合、修正するべきは自動生成するツール側です。

また、SpotBugsのプラグインとして動作する「使用不許可APIチェックツール」の対象外にしたい場合はチェック対象から除外しても良いでしょう。
その場合であっても、パッケージ全体といった広範囲を対象外にするのではなく、特定のクラスのみを対象外とするという風に除外設定は局所化すべきです。

## チェック対象から除外する方法

### フィルタファイルによる除外方法

SpotBugsは[フィルタファイル](http://spotbugs.readthedocs.io/ja/latest/filter.html)と呼ばれるXMLファイルを使用して特定のクラスなどをチェック対象外にできます。 
[MavenでのSpotBugsの実行方法](./Maven-settings.md)に従ってSpotBugsを組み込んでいると`spotbugs/spotbugs_exclude_for_production.xml`にフィルタファイルが置かれています。

開発者から除外申請をRedmine等の課題管理システムで受け付けて管理するようにします。
アーキテクトは除外申請が妥当であり除外することを決定した場合、フィルタファイルに除外設定を追加します。

フィルタファイルには、次の2つを記載します。

- 対象クラス（または対象パッケージ）
- 検出するバグの種類

フィルタファイルの記載例を示します。

```xml
<FindBugsFilter>

  <!-- 自動生成されるソースコードを除外する設定 -->
  <Match>
    <Or>
      <!-- 自動生成されるソースコードが特定のパッケージに出力される場合の除外設定 -->
      <Package name="com.example.generated"/>
      <!-- 自動生成されるソースコードのクラス名に規則性がある場合の除外設定 -->
      <Class name="~com\.example\.Generated.+"/>
    </Or>
  </Match>

  <!-- 使用不許可APIチェック対象外にする設定 -->
  <Match>
    <!-- 特定のメソッドを使用不許可APIチェック対象外にする -->
    <Bug pattern="UPU_UNPUBLISHED_API_USAGE"/>
    <Class name="com.example.Foobar"/>
    <Method name="baz" params="java.lang.String, int"/>
  </Match>

</FindBugsFilter>
```

`Match`要素の直下に`Bug`要素がある場合は指定されたバグの検出対象外にします。
`Bug`要素が無い場合はSpotBugsが検出できるすべてのバグに対して検出対象外にします。

`Or`要素の直下に`Package`要素か`Class`要素があり、それぞれチェック対象外にするパッケージの指定・クラスの指定をします。
`name`属性値と完全一致するパッケージ・クラスを対象外とします。
`name`属性値はチルダ（`~`）から開始した場合は正規表現となります。

使用不許可APIチェック対象外にする設定例では`Method`要素があり、メソッド単位でチェック対象外にするように設定しています。

より詳しくは[公式サイトのフィルタファイル解説](http://spotbugs.readthedocs.io/ja/latest/filter.html)を参照してください。

除外設定をする場合は次のようにしておくと、後で経緯を追跡できます。

- 課題管理システムの課題管理番号をXMLコメントに記載する
- バージョン管理システムのコミットコメントに記載する

### 使用不許可APIチェックツールで特定のAPIの使用を許可する

使用不許可APIチェックツールでは設定ファイルを修正して特定のAPIの使用を許可できます。

使用不許可APIチェックでNGとなったAPIを確認して、開発に必要なものであった場合はプロジェクトのアーキテクトに相談してください。
アーキテクトは該当のAPIが開発に必要なものであると認められたら、使用不許可APIチェックツールの設定ファイルを編集して使用を許可してください。

設定ファイルの書き方は[使用不許可APIチェックツール](../../unpublished-api/README.md#設定ファイル記述方法)の解説を参照してください。

